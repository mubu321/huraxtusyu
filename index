import React, { useState, useEffect, useRef } from 'react';

const ExtremeFlashAnzan = () => {
  const [numbers, setNumbers] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(-1);
  const [isRunning, setIsRunning] = useState(false);
  const [userAnswer, setUserAnswer] = useState('');
  const [correctSum, setCorrectSum] = useState('');
  const [showResult, setShowResult] = useState(false);
  const [isComplete, setIsComplete] = useState(false);
  const intervalRef = useRef(null);

  // 900æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ã‚’ç”Ÿæˆ
  const generateRandomNumber = () => {
    let num = '';
    // æœ€åˆã®æ¡ã¯1-9ï¼ˆå…ˆé ­0ã‚’é¿ã‘ã‚‹ï¼‰
    num += Math.floor(Math.random() * 9) + 1;
    // æ®‹ã‚Š899æ¡ã¯0-9
    for (let i = 1; i < 900; i++) {
      num += Math.floor(Math.random() * 10);
    }
    return num;
  };

  // å¤§ããªæ•°ã®åŠ ç®—é–¢æ•°
  const addBigNumbers = (num1, num2) => {
    const arr1 = num1.split('').reverse();
    const arr2 = num2.split('').reverse();
    const result = [];
    let carry = 0;
    const maxLength = Math.max(arr1.length, arr2.length);

    for (let i = 0; i < maxLength; i++) {
      const digit1 = parseInt(arr1[i] || '0');
      const digit2 = parseInt(arr2[i] || '0');
      const sum = digit1 + digit2 + carry;
      result.push(sum % 10);
      carry = Math.floor(sum / 10);
    }

    if (carry > 0) {
      result.push(carry);
    }

    return result.reverse().join('');
  };

  // 50å€‹ã®900æ¡æ•°å­—ã‚’ç”Ÿæˆã—ã€åˆè¨ˆã‚’è¨ˆç®—
  const generateNumbers = () => {
    const newNumbers = [];
    for (let i = 0; i < 50; i++) {
      newNumbers.push(generateRandomNumber());
    }
    
    // åˆè¨ˆã‚’è¨ˆç®—
    let sum = '0';
    for (const num of newNumbers) {
      sum = addBigNumbers(sum, num);
    }
    
    setNumbers(newNumbers);
    setCorrectSum(sum);
    return newNumbers;
  };

  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é–‹å§‹
  const startFlash = () => {
    const nums = generateNumbers();
    setCurrentIndex(0);
    setIsRunning(true);
    setShowResult(false);
    setIsComplete(false);
    setUserAnswer('');

    let index = 0;
    intervalRef.current = setInterval(() => {
      if (index >= nums.length) {
        setCurrentIndex(-1);
        setIsRunning(false);
        setIsComplete(true);
        clearInterval(intervalRef.current);
      } else {
        setCurrentIndex(index);
        index++;
      }
          }, 50); // 50msé–“éš”
  };

  // åœæ­¢
  const stopFlash = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
    }
    setIsRunning(false);
    setCurrentIndex(-1);
  };

  // çµæœè¡¨ç¤º
  const showAnswer = () => {
    setShowResult(true);
  };

  // ãƒªã‚»ãƒƒãƒˆ
  const reset = () => {
    stopFlash();
    setNumbers([]);
    setCurrentIndex(-1);
    setUserAnswer('');
    setShowResult(false);
    setIsComplete(false);
    setCorrectSum('');
  };

  useEffect(() => {
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-900 via-black to-red-900 text-white p-8">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold mb-2 text-red-400">
            ğŸ”¥ EXTREME FLASH ANZAN ğŸ”¥
          </h1>
          <p className="text-xl text-red-300">
            900æ¡ Ã— 50å€‹ Ã— 50ms - ç©¶æ¥µã®é«˜é€Ÿæš—ç®—
          </p>
        </div>

        {/* æ•°å­—è¡¨ç¤ºã‚¨ãƒªã‚¢ */}
        <div className="bg-black border-4 border-red-500 rounded-lg p-8 mb-8 min-h-[300px] flex items-center justify-center">
          {isRunning && currentIndex >= 0 && currentIndex < numbers.length ? (
            <div className="text-center">
              <div className="text-red-400 text-lg mb-2">
                {currentIndex + 1} / 50
              </div>
              <div className="font-mono text-lg text-green-400 break-all leading-tight overflow-hidden">
                {numbers[currentIndex]}
              </div>
            </div>
          ) : isComplete ? (
            <div className="text-center">
              <div className="text-6xl mb-4">ğŸ¯</div>
              <div className="text-2xl text-yellow-400">å®Œäº†ï¼</div>
              <div className="text-lg text-gray-300 mt-2">
                ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
              </div>
            </div>
          ) : (
            <div className="text-center">
              <div className="text-6xl mb-4">âš¡</div>
              <div className="text-2xl text-gray-400">
                æº–å‚™å®Œäº† - ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„
              </div>
            </div>
          )}
        </div>

        {/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
        <div className="flex flex-wrap justify-center gap-4 mb-8">
          <button
            onClick={startFlash}
            disabled={isRunning}
            className="px-8 py-3 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-bold text-xl transition-colors"
          >
            {isRunning ? 'å®Ÿè¡Œä¸­...' : 'ã‚¹ã‚¿ãƒ¼ãƒˆ'}
          </button>
          
          <button
            onClick={stopFlash}
            disabled={!isRunning}
            className="px-8 py-3 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-bold text-xl transition-colors"
          >
            ã‚¹ãƒˆãƒƒãƒ—
          </button>
          
          <button
            onClick={reset}
            className="px-8 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold text-xl transition-colors"
          >
            ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>

        {/* ç­”ãˆå…¥åŠ›ã‚¨ãƒªã‚¢ */}
        {isComplete && (
          <div className="bg-gray-900 border-2 border-gray-700 rounded-lg p-6 mb-6">
            <h3 className="text-xl font-bold mb-4 text-center">ã‚ãªãŸã®ç­”ãˆ</h3>
            <textarea
              value={userAnswer}
              onChange={(e) => setUserAnswer(e.target.value)}
              placeholder="åˆè¨ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
              className="w-full h-32 p-4 bg-black border border-gray-600 rounded text-white font-mono resize-none"
            />
            <div className="text-center mt-4">
              <button
                onClick={showAnswer}
                className="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold transition-colors"
              >
                æ­£è§£ã‚’è¡¨ç¤º
              </button>
            </div>
          </div>
        )}

        {/* çµæœè¡¨ç¤º */}
        {showResult && (
          <div className="bg-gray-900 border-2 border-gray-700 rounded-lg p-6">
            <h3 className="text-xl font-bold mb-4 text-center">çµæœ</h3>
            
            <div className="mb-4">
              <div className="text-lg font-bold text-green-400 mb-2">æ­£è§£:</div>
              <div className="font-mono text-sm bg-black p-3 rounded border break-all">
                {correctSum}
              </div>
            </div>
            
            <div className="mb-4">
              <div className="text-lg font-bold text-blue-400 mb-2">ã‚ãªãŸã®ç­”ãˆ:</div>
              <div className="font-mono text-sm bg-black p-3 rounded border break-all">
                {userAnswer || '(æœªå…¥åŠ›)'}
              </div>
            </div>
            
            <div className="text-center">
              {userAnswer === correctSum ? (
                <div className="text-2xl text-green-400 font-bold">
                  ğŸ‰ æ­£è§£ï¼ï¼ç´ æ™´ã‚‰ã—ã„ï¼ ğŸ‰
                </div>
              ) : (
                <div className="text-xl text-red-400 font-bold">
                  ğŸ’ª æƒœã—ã„ï¼å†æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
                </div>
              )}
            </div>
          </div>
        )}

        {/* æƒ…å ±ãƒ‘ãƒãƒ« */}
        <div className="mt-8 text-center text-sm text-gray-400">
          <p>âš ï¸ æ¥µé™è¨­å®š: 900æ¡ã®æ•°å­—ã‚’50å€‹ã€å„50msï¼ˆ0.05ç§’ï¼‰ã§è¡¨ç¤º</p>
          <p>ç·è¡¨ç¤ºæ™‚é–“: ã‚ãšã‹2.5ç§’ï¼äººé–“ã®é™ç•Œã‚’å®Œå…¨ã«è¶…è¶Šï¼</p>
        </div>
      </div>
    </div>
  );
};

export default ExtremeFlashAnzan;
